#!/usr/bin/env bash

echo "-----> DatadogBuildpack/supply"

BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "       Installing Datadog Agent"


mkdir -p $BUILD_DIR/datadog/scripts
mkdir -p $BUILD_DIR/datadog/extracted-agent
mkdir -p $BUILD_DIR/.profile.d

# Extract agent
dpkg -x $ROOT_DIR/lib/datadog-agent.deb $BUILD_DIR/datadog/extracted-agent
mv $BUILD_DIR/datadog/extracted-agent/opt $BUILD_DIR/datadog/opt
mv $BUILD_DIR/datadog/extracted-agent/etc $BUILD_DIR/datadog/etc
mv $BUILD_DIR/datadog/etc/datadog-agent/conf.d $BUILD_DIR/datadog/etc/datadog-agent/disabled_confd
rm -rf $BUILD_DIR/datadog/extracted-agent
rm -rf $BUILD_DIR/datadog/opt/datadog-agent/embedded/lib/python2.7

cp $ROOT_DIR/lib/scripts/get_tags.py $BUILD_DIR/datadog/scripts/get_tags.py
cp $ROOT_DIR/lib/scripts/create_logs_config.py $BUILD_DIR/datadog/scripts/create_logs_config.py
cp $ROOT_DIR/lib/scripts/setup.sh $BUILD_DIR/datadog/scripts/setup.sh
cp $ROOT_DIR/lib/scripts/datadog-agent $BUILD_DIR/datadog/datadog-agent
cp $ROOT_DIR/lib/test-endpoint.sh $BUILD_DIR/.profile.d/00-test-endpoint.sh # Make sure this is sourced first
cp $ROOT_DIR/lib/redirect-logs.sh $BUILD_DIR/.profile.d/01-redirect-logs.sh
cp $ROOT_DIR/lib/run-datadog.sh $BUILD_DIR/.profile.d/02-run-datadog.sh

chmod +x $BUILD_DIR/.profile.d/00-test-endpoint.sh
chmod +x $BUILD_DIR/.profile.d/01-redirect-logs.sh
chmod +x $BUILD_DIR/.profile.d/02-run-datadog.sh
chmod +x $BUILD_DIR/datadog/datadog-agent
chmod +x $BUILD_DIR/datadog/scripts/setup.sh
