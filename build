#!/bin/bash

SRCDIR=$(cd "$(dirname $0)/." && pwd)
NAME="datadog-cloudfoundry-buildpack"
ZIPFILE="$NAME.zip"
DOGSTATSD_DOWNLOAD_URL="https://s3.amazonaws.com/dd-agent/dsd6/dogstatsd/linux"
TRACEAGENT_DOWNLOAD_URL="https://github.com/DataDog/datadog-trace-agent/releases/download/5.20.0/trace-agent-linux"

if [ ! -f ./lib/dogstatsd ] || [ ! -f ./lib/trace-agent ]; then
  DOWNLOAD="true"
fi
if [ -n "$REFRESH_ASSETS" ]; then
  DOWNLOAD="true"
fi
if [ -n "$DOWNLOAD" ]; then
  if [ -n "$VERSION" ]; then
    DOGSTATSD_DOWNLOAD_URL="$DOGSTATSD_DOWNLOAD_URL/dogstatsd-$VERSION"
  else
    DOGSTATSD_DOWNLOAD_URL="$DOGSTATSD_DOWNLOAD_URL/dogstatsd-latest"
  fi

  curl $DOGSTATSD_DOWNLOAD_URL -o ./lib/dogstatsd
  # Does not support versioning for now, keep it dumb until trace-agent merge with the Agent6
  curl -L $TRACEAGENT_DOWNLOAD_URL -o ./lib/trace-agent
  chmod +x ./lib/dogstatsd
  chmod +x ./lib/trace-agent
fi

rm -f $ZIPFILE

pushd $SRCDIR
  zip -r "$ZIPFILE" lib bin
popd
